{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ user_subject }} - Teacher Dashboard | cloudED</title>
  <link rel="stylesheet" href="{% static 'css/teacherdashboard.css' %}"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* Additional styles for delete functionality */
    .course-card {
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .course-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .course-card.selected {
      border: 2px solid #7f65f3;
      background: #f8f7ff;
    }
    
    .delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff4757;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.3s ease;
      z-index: 10;
    }
    
    .course-card:hover .delete-btn {
      display: flex;
    }
    
    .delete-btn:hover {
      background: #ff3742;
      transform: scale(1.1);
    }
    
    .file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    margin: 8px 0;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.file-item:hover {
    background: #e9ecef;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.file-icon {
    font-size: 24px;
    margin-right: 12px;
}

.file-details h4 {
    margin: 0 0 5px 0;
    font-size: 16px;
    color: #333;
    font-weight: 600;
}

.file-details p {
    margin: 0;
    font-size: 13px;
    color: #666;
}

.file-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

@media (max-width: 768px) {
    .file-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .file-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .preview-modal-content {
        width: 95%;
        height: 95%;
    }
}
    
    .file-delete-btn {
      background: #ff4757;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s ease;
    }
    
    .file-delete-btn:hover {
      background: #ff3742;
    }
    
    .file-download-btn {
      background: #7f65f3;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s ease;
    }
    
    .file-download-btn:hover {
      background: #6c5ce7;
    }

    .file-preview-btn {
    background: #17a2b8;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.3s ease;
    margin-right: 5px;
}

.file-preview-btn:hover {
    background: #138496;
}
    
    .files-section {
      margin-top: 20px;
    }
    
    .files-section h4 {
      color: #333;
      margin-bottom: 15px;
    }
    
    .no-files {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }
    
    /* Empty state styles */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    
    .empty-state i {
      font-size: 64px;
      color: #ddd;
      margin-bottom: 20px;
    }
    
    .empty-state h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 24px;
    }
    
    .empty-state p {
      margin-bottom: 30px;
      font-size: 16px;
      line-height: 1.5;
    }
    
    .empty-state .create-first-folder {
      background: #7f65f3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .empty-state .create-first-folder:hover {
      background: #6c5ce7;
    }
    
    /* Hide create folder button when empty */
    .course-container:empty + #createFolderBtn {
      display: none;
    }
    
    /* Unit view styles */
    .unit-view {
      display: none;
    }
    
    .unit-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #7f65f3;
    }
    
    .unit-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .unit-title h2 {
      margin: 0;
      color: #333;
      font-size: 24px;
    }
    
    .unit-title .unit-icon {
      background: #7f65f3;
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s ease;
    }
    
    .back-btn:hover {
      background: #5a6268;
    }
    
    .unit-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 20px;
    }
    
    @media (max-width: 768px) {
      .unit-content {
        grid-template-columns: 1fr;
      }
    }
    
    .upload-section-unit {
      background: white;
      padding: 25px;
      border-radius: 10px;
      border: 1px solid #e9ecef;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .upload-section-unit h3 {
      margin-top: 0;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .files-section-unit {
      background: white;
      padding: 25px;
      border-radius: 10px;
      border: 1px solid #e9ecef;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .files-section-unit h3 {
      margin-top: 0;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .upload-box {
      border: 2px dashed #ddd;
      border-radius: 10px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 20px 0;
    }
    
    .upload-box:hover {
      border-color: #7f65f3;
      background: #f8f7ff;
    }
    
    .upload-box.dragover {
      border-color: #7f65f3;
      background: #f0f0f0;
    }
    
    .upload-icon {
      color: #7f65f3;
      margin-bottom: 15px;
    }
    
    .upload-box textarea {
      border: none;
      background: transparent;
      resize: none;
      width: 100%;
      text-align: center;
      color: #666;
      font-size: 14px;
    }
    
    .upload-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .upload-actions button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .upload-actions button:first-child {
      background: #6c757d;
      color: white;
    }
    
    .upload-actions button:first-child:hover {
      background: #5a6268;
    }
    
    /* Teacher info styles */
    .teacher-info {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .teacher-info i {
      color: #7f65f3;
    }
    
    /* Confirmation modal styles */
    .confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .confirm-modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    
    .confirm-modal h3 {
      color: #333;
      margin-bottom: 15px;
    }
    
    .confirm-modal p {
      color: #666;
      margin-bottom: 25px;
    }
    
    .confirm-modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    
    .confirm-delete-btn {
      background: #ff4757;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .confirm-cancel-btn {
      background: #ddd;
      color: #333;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Preview Modal Styles */
    .preview-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.preview-modal-content {
    background: white;
    border-radius: 10px;
    width: 90%;
    max-width: 1000px;
    height: 90%;
    max-height: 800px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.preview-header h3 {
    margin: 0;
    color: #333;
    font-size: 18px;
}

.close-preview {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6c757d;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-preview:hover {
    color: #dc3545;
}

.preview-body {
    flex: 1;
    padding: 0;
    overflow: hidden;
}

.preview-body iframe {
    width: 100%;
    height: 100%;
    border: none;
}

.preview-footer {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.download-from-preview {
    background: #28a745;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
}

.download-from-preview:hover {
    background: #218838;
}

.close-from-preview {
    background: #6c757d;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
}

.close-from-preview:hover {
    background: #5a6268;
}/* ---------- Upload Section Wrapper ---------- */
.upload-section {
    max-width: 600px;
    margin: 40px auto;
    padding: 20px;
    border-radius: 16px;
    background: #ffffff;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    font-family: "Segoe UI", sans-serif;
}

/* ---------- Upload Box (initial view) ---------- */
#uploadBox {
    border: 2px dashed #0d6efd;
    padding: 40px 20px;
    text-align: center;
    border-radius: 16px;
    cursor: pointer;
    transition: background 0.3s ease;
    background-color: #f8f9fa;
}
#uploadBox:hover {
    background-color: #e9f2ff;
}
/* Icon + helper text */
#uploadBox .upload-icon {
    font-size: 48px;
    color: #0d6efd;
    margin-bottom: 12px;
}
#uploadBox textarea {
    width: 100%;
    border: none;
    resize: none;
    background: transparent;
    text-align: center;
    color: #495057;
    font-size: 15px;
    font-weight: 500;
}
#uploadBox input[type="file"] {
    display: none;   /* keep native input hidden */
}

/* ---------- File‚Äëpreview area (shown after upload) ---------- */
#filePreviewContainer {
    display: none;          /* JS toggles to block/flex */
    margin-top: 20px;
}
#selectedFilesList .file-preview {
    display: flex;
    align-items: center;
    background: #f1f3f5;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 12px;
}
#selectedFilesList .file-preview i {
    font-size: 28px;
    margin-right: 15px;
    color: #0d6efd;  /* default icon colour */
}
#selectedFilesList .file-preview .file-name {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    word-break: break-all;
}

/* ---------- Action buttons (‚ÄúSave as Draft‚Äù, ‚ÄúPublish Files‚Äù) ---------- */
.upload-actions {
    /* display: none; */  /* ‚Üê REMOVE or comment this */
    justify-content: flex-start;
    margin-top: 20px;
    gap: 10px;
}

.upload-actions button {
    background-color: #0d6efd;
    border: none;
    color: #ffffff;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s ease-in-out;
    display: flex;
    align-items: center;
    gap: 6px;
    position: relative;
    top: 320px;
    max-height: 50px;
}
.upload-actions button:hover {
    background-color: #0b5ed7;
}

/* ---------- Drag‚Äëand‚Äëdrop visual cues ---------- */
#uploadBox.dragover {
    background-color: #e2f0ff;
    border-color: #0b5ed7;
}

/* ---------- Optional utility class ---------- */
.hidden { display: none !important; }

  </style>
</head>
<body>
  <!-- Add CSRF token to the page -->
  {% csrf_token %}
  
  <header>
    <div class="header-left">
      <i class="fas fa-graduation-cap logo-icon" style="font-size: 30px;"></i>
      <span class="logo-text" style="font-size: 30px; color: rgb(133, 133, 133);">cloud<span style="color: #7f65f3;">ED</span></span>
    </div>
    <div class="header-right">
      <div class="user-icon" onclick="toggleDropdown()"><i class="fas fa-user"></i></div>
      <div class="dropdown" id="dropdownMenu">
        <p><strong>{{ user_name }}</strong></p>
        <p style="font-size: 12px; color: #666; margin: 5px 0;">{{ user_email }}</p>
        <a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt" style="margin-right: 6px;"></i>Logout</a>
      </div>
    </div>
  </header>
  
  <div class="dashboard">
    <aside class="sidebar">
      <div class="profile">
        <div class="user-icon"><i class="fas fa-user"></i></div>
        <div class="info">
          <h3>{{ user_name }}</h3>
          <p>{{ user_email }}</p>
          <div class="teacher-info">
            <i class="fas fa-chalkboard-teacher"></i>
            <span>{{ user_subject }}</span>
          </div>
        </div>
      </div>
      <nav>
        <button class="nav-item active" onclick="showHome()">üè† Home</button>
        
      </nav>
    </aside>
    
    <main class="main">
      <!-- Home Section -->
      <div class="home-section">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
          <div>
            <h2>{{ user_subject }}</h2>
            <div class="teacher-info">
              <i class="fas fa-user"></i>
              <span>Instructor: {{ user_name }}</span>
            </div>
          </div>
        </div>
        
        <div class="course-container" id="courseContainer">
          <!-- Load existing units -->
          {% for unit in units %}
            <div class="course-card" onclick="openUnit('{{ unit.name }}', {{ unit.id }})">
              <div class="unit">{{ unit.name }}</div>
              <button class="delete-btn" onclick="event.stopPropagation(); deleteFolder(event, this, {{ unit.id }})" title="Delete unit">
                <i class="fas fa-times"></i>
              </button>
            </div>
          {% endfor %}
        </div>
        
        <!-- Empty state message -->
        <div class="empty-state" id="emptyState" {% if units %}style="display: none;"{% endif %}>
          <i class="fas fa-folder-open"></i>
          <h3>No Course Units Yet</h3>
          <p>Get started by creating your first course unit for <strong>{{ user_subject }}</strong>.<br>You can organize your course materials into different units or chapters.</p>
          <button class="create-first-folder" onclick="createFolder()">
            <i class="fas fa-plus" style="margin-right: 8px;"></i>Create Your First Unit
          </button>
        </div>
        
        <button id="createFolderBtn" onclick="createFolder()" {% if not units %}style="display: none;"{% endif %}>Create Unit +</button>
      </div>
      
      <!-- Unit View Section -->
      <div class="unit-view" id="unitView">
        <div class="unit-header">
          <div class="unit-title">
            <div class="unit-icon">
              <i class="fas fa-folder"></i>
            </div>
            <div>
              <h2 id="currentUnitName">Unit Name</h2>
              <p style="margin: 0; color: #666;">{{ user_subject }} - {{ user_name }}</p>
            </div>
          </div>
          <button class="back-btn" onclick="backToHome()">
            <i class="fas fa-arrow-left"></i>
            Back to Units
          </button>
        </div>
        
        <div class="unit-content">
 <!-- Upload Section -->
<div class="upload-box" id="uploadBox"
     onclick="triggerFileInput()">

    <!-- Upload Icon -->
    <div class="upload-icon" id="uploadIcon">
        <i class="fas fa-cloud-upload-alt"></i>
    </div>

    <textarea readonly rows="2">
Drag and drop files or click here to browse...
Select multiple files to upload them together.
    </textarea>

    <input type="file" id="fileInput" 
           accept=".pdf,.doc,.docx,.ppt,.pptx,.txt" 
           multiple 
           onchange="handleFileSelect(event)">

    <!-- File Preview Container -->
    <div id="filePreviewContainer" style="display: none; margin-top: 20px;">
        <div id="selectedFilesList"></div>
    </div>
</div>

<!-- Tag Selection -->
<div class="tag-selection" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
    <label for="fileTag" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
        <i class="fas fa-tag" style="margin-right: 8px; color: #7f65f3;"></i>
        Material Type:
    </label>
    <select id="fileTag" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
        <option value="study_material">Study Material</option>
        <option value="assignment">Assignment</option>
        <option value="personal_note">Personal Note</option>
        <option value="question_bank">Question Bank</option>
    </select>
</div>

<!-- Upload Actions -->
<div class="upload-actions">

    <button onclick="publishFiles()">
        <i class="fas fa-paper-plane"></i>
        Publish Files
    </button>
</div>

       
 
          <!-- Files Section -->
          <div class="files-section-unit">
            <h3>
              <i class="fas fa-file-alt"></i>
              Unit Files
            </h3>
            <div id="unitFilesList">
              <div class="no-files">No files uploaded yet.</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- All Files Section -->
      <div class="files-section-container" style="display: none;">
        <h2>All Files - {{ user_subject }}</h2>
        <div class="teacher-info" style="margin-bottom: 20px;">
          <i class="fas fa-user"></i>
          <span>Instructor: {{ user_name }}</span>
        </div>
        <div class="files-section" id="filesSection">
          <h4>All Uploaded Files</h4>
          <div id="allFilesList">
            <div class="no-files">No files uploaded yet.</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Folder Name Modal -->
  <div class="modal" id="folderModal" style="display: none;">
    <div class="modal-content">
      <h3>Create New Unit for {{ user_subject }}</h3>
      <input type="text" id="folderInput" placeholder="e.g., Introduction to {{ user_subject }}, Unit 1, Chapter 2" />
      <div class="modal-buttons">
        <button onclick="submitFolderName()">Create Unit</button>
        <button class="cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="confirm-modal" id="confirmModal">
    <div class="confirm-modal-content">
      <h3 id="confirmTitle">Confirm Delete</h3>
      <p id="confirmMessage">Are you sure you want to delete this item?</p>
      <div class="confirm-modal-buttons">
        <button class="confirm-delete-btn" id="confirmDeleteBtn">Delete</button>
        <button class="confirm-cancel-btn" onclick="closeConfirmModal()">Cancel</button>
      </div>
    </div>
  </div>

<script>
let selectedUnit = null;
let currentViewingUnit = null;
let currentUnitId = null;

// Teacher info from Django context
const teacherName = "{{ user_name }}";
const teacherEmail = "{{ user_email }}";
const teacherSubject = "{{ user_subject }}";

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Set up CSRF token for all AJAX requests
const csrftoken = getCookie('csrftoken');

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    updateEmptyState();
    
    // Set up CSRF token for all fetch requests
    const originalFetch = window.fetch;
    window.fetch = function(url, options = {}) {
        if (!options.headers) {
            options.headers = {};
        }
        
        // Add CSRF token for POST, PUT, DELETE requests
        if (['POST', 'PUT', 'DELETE'].includes(options.method)) {
            options.headers['X-CSRFToken'] = csrftoken;
        }
        
        return originalFetch(url, options);
    };
});

function updateEmptyState() {
    const container = document.getElementById("courseContainer");
    const emptyState = document.getElementById("emptyState");
    const createBtn = document.getElementById("createFolderBtn");
    
    if (container.children.length === 0) {
        emptyState.style.display = "block";
        createBtn.style.display = "none";
    } else {
        emptyState.style.display = "none";
        createBtn.style.display = "block";
    }
}

function toggleDropdown() {
    const menu = document.getElementById("dropdownMenu");
    menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
}

function createFolder() {
    document.getElementById("folderModal").style.display = "flex";
    document.getElementById("folderInput").value = "";
    document.getElementById("folderInput").focus();
}

async function submitFolderName() {
    const name = document.getElementById("folderInput").value.trim();
    if (!name) {
        alert("Please enter a unit name.");
        return;
    }
    
    try {
        console.log("Creating unit with name:", name);
        
        const response = await fetch('/api/create-unit/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ name: name })
        });
        
        console.log("Response status:", response.status);
        const data = await response.json();
        console.log("Response data:", data);
        
        if (data.success) {
            const container = document.getElementById("courseContainer");
            const card = document.createElement("div");
            card.className = "course-card";
            card.onclick = () => openUnit(name, data.unit.id);
            
            const unitDiv = document.createElement("div");
            unitDiv.className = "unit";
            unitDiv.textContent = name;
            
            const deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-btn";
            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            deleteBtn.title = "Delete unit";
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteFolder(e, deleteBtn, data.unit.id);
            };
            
            card.appendChild(unitDiv);
            card.appendChild(deleteBtn);
            container.appendChild(card);
            
            updateEmptyState();
            document.getElementById("folderModal").style.display = "none";
            showSuccessMessage(`Unit "${name}" created successfully! Email notifications sent to all students.`);
        } else {
            alert(data.error || 'Failed to create unit');
        }
    } catch (error) {
        console.error('Error creating unit:', error);
        alert('Failed to create unit. Please try again.');
    }
}

function closeModal() {
    document.getElementById("folderModal").style.display = "none";
}

function openUnit(unitName, unitId) {
    currentViewingUnit = unitName;
    currentUnitId = unitId;
    
    // Hide home section and show unit view
    document.querySelector(".home-section").style.display = "none";
    document.getElementById("unitView").style.display = "block";
    
    // Update unit name in header
    document.getElementById("currentUnitName").textContent = unitName;
    
    // Load unit files
    loadUnitFiles(unitId);
}

async function loadUnitFiles(unitId) {
    try {
        const unitFilesList = document.getElementById("unitFilesList");
        unitFilesList.innerHTML = '<div class="no-files">Loading files...</div>';
        
        // Find the unit data from Django context
        {% for unit in units %}
            if ({{ unit.id }} == unitId) {
                const files = [
                    {% for file in unit.files.all %}
                        {
                            id: {{ file.id }},
                            name: "{{ file.original_name }}",
                            size: "{{ file.get_file_size_display }}",
                            uploaded_at: "{{ file.uploaded_at|date:'Y-m-d H:i' }}",
                            is_published: {{ file.is_published|yesno:"true,false" }},
                            file_type: "{{ file.file_type }}",
                            can_preview: {{ file.can_preview|yesno:"true,false" }}
                        },
                    {% endfor %}
                ];
                
                updateUnitFilesList(files);
                return;
            }
        {% endfor %}
        
        // If no files found
        updateUnitFilesList([]);
        
    } catch (error) {
        console.error('Error loading unit files:', error);
        document.getElementById("unitFilesList").innerHTML = '<div class="no-files">Error loading files.</div>';
    }
}

function updateUnitFilesList(files) {
    const unitFilesList = document.getElementById("unitFilesList");
    
    if (files.length === 0) {
        unitFilesList.innerHTML = '<div class="no-files">No files uploaded to this unit yet.</div>';
        return;
    }
    
    unitFilesList.innerHTML = '';
    
    files.forEach(file => {
        const fileItem = document.createElement("div");
        fileItem.className = "file-item";
        
        const statusBadge = file.is_published ? 
            '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">PUBLISHED</span>' :
            '<span style="background: #ffc107; color: #333; padding: 2px 6px; border-radius: 3px; font-size: 10px;">DRAFT</span>';
        
        // Determine file icon and color
        let fileIcon = 'fa-file';
        let fileColor = '#6c757d';
        
        if (file.file_type.includes('pdf')) {
            fileIcon = 'fa-file-pdf';
            fileColor = '#dc3545';
        } else if (file.file_type.includes('word') || file.file_type.includes('document')) {
            fileIcon = 'fa-file-word';
            fileColor = '#2b579a';
        } else if (file.file_type.includes('powerpoint') || file.file_type.includes('presentation')) {
            fileIcon = 'fa-file-powerpoint';
            fileColor = '#d24726';
        } else if (file.file_type.includes('text')) {
            fileIcon = 'fa-file-alt';
            fileColor = '#6c757d';
        }
        
        // Create preview button if file can be previewed
        const previewButton = file.can_preview ? 
            `<button class="file-preview-btn" onclick="previewFile(${file.id}, '${file.name}')" title="Preview file">
                <i class="fas fa-eye"></i> Preview
            </button>` : '';
        
        fileItem.innerHTML = `
            <div class="file-info">
                <i class="fas ${fileIcon} file-icon" style="color: ${fileColor};"></i>
                <div class="file-details">
                    <h4>${file.name} ${statusBadge}</h4>
                    <p>Size: ${file.size} | Uploaded: ${file.uploaded_at} | By: ${teacherName}</p>
                </div>
            </div>
            <div class="file-actions">
                ${previewButton}
                <button class="file-download-btn" onclick="downloadFile(${file.id})" title="Download file">
                    <i class="fas fa-download"></i> Download
                </button>
                <button class="file-delete-btn" onclick="deleteFile(${file.id}, '${file.name}')" title="Delete file">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        `;
        
        unitFilesList.appendChild(fileItem);
    });
}

function previewFile(fileId, fileName) {
    // Create modal for file preview
    const modal = document.createElement('div');
    modal.className = 'preview-modal';
    modal.innerHTML = `
        <div class="preview-modal-content">
            <div class="preview-header">
                <h3><i class="fas fa-eye"></i> Preview: ${fileName}</h3>
                <button class="close-preview" onclick="closePreview()">&times;</button>
            </div>
            <div class="preview-body">
                <iframe src="/api/preview-file/${fileId}/" width="100%" height="600px" frameborder="0">
                    <p>Your browser does not support iframes. <a href="/api/download-file/${fileId}/" target="_blank">Download the file</a> instead.</p>
                </iframe>
            </div>
            <div class="preview-footer">
                <button onclick="downloadFile(${fileId})" class="download-from-preview">
                    <i class="fas fa-download"></i> Download File
                </button>
                <button onclick="closePreview()" class="close-from-preview">
                    <i class="fas fa-times"></i> Close Preview
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.style.display = 'flex';
}

function closePreview() {
    const modal = document.querySelector('.preview-modal');
    if (modal) {
        modal.remove();
    }
}
async function handleFileSelect(event) {
    const files = event.target.files;
    if (files.length > 0 && currentUnitId) {
        console.log("Uploading files:", Array.from(files).map(f => f.name));
        console.log("Unit ID:", currentUnitId);

        const formData = new FormData();
        formData.append('unit_id', currentUnitId);

        // Get selected tag
        const tagSelect = document.getElementById('fileTag');
        const selectedTag = tagSelect ? tagSelect.value : 'study_material';
        formData.append('tag', selectedTag);

        for (let file of files) {
            formData.append('files', file);
        }

        try {
            const response = await fetch('/api/upload-file/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            });

            console.log("Upload response status:", response.status);
            const data = await response.json();
            console.log("Upload response data:", data);

            if (data.success) {
                showSuccessMessage(`${data.message}! Email notifications sent to all students.`);
                loadUnitFiles(currentUnitId);
                event.target.value = '';
            } else {
                alert(data.error || 'Failed to upload files');
            }
        } catch (error) {
            console.error('Error uploading files:', error);
            alert('Failed to upload files. Please try again.');
        }
    }
}

async function publishFiles() {
    if (!currentUnitId) {
        alert("Please select a unit first.");
        return;
    }
    
    try {
        const response = await fetch('/api/publish-files/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ unit_id: currentUnitId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccessMessage(`${data.message}! Email notifications sent to all students.`);
            loadUnitFiles(currentUnitId);
        } else {
            alert(data.error || 'Failed to publish files');
        }
    } catch (error) {
        console.error('Error publishing files:', error);
        alert('Failed to publish files. Please try again.');
    }
}

function saveDraft() {
    showSuccessMessage(`Files saved as draft for ${teacherSubject}!`);
}

async function deleteFolder(event, deleteBtn, unitId) {
    event.stopPropagation();
    const card = deleteBtn.closest('.course-card');
    const folderName = card.querySelector('.unit').textContent;
    
    if (confirm(`Are you sure you want to delete "${folderName}"? This will also delete all files in this unit.`)) {
        try {
            const response = await fetch(`/api/delete-unit/${unitId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                card.remove();
                
                if (currentUnitId === unitId) {
                    backToHome();
                }
                
                updateEmptyState();
                showSuccessMessage(data.message);
            } else {
                alert(data.error || 'Failed to delete unit');
            }
        } catch (error) {
            console.error('Error deleting unit:', error);
            alert('Failed to delete unit. Please try again.');
        }
    }
}

function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        z-index: 1001;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;
    successDiv.innerHTML = `<i class="fas fa-check-circle" style="margin-right: 8px;"></i>${message}`;
    
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        successDiv.remove();
    }, 5000);
}

function closeConfirmModal() {
  document.getElementById("confirmModal").style.display = "none";
}

// Close modals when clicking outside
window.onclick = function(event) {
    const folderModal = document.getElementById("folderModal");
    const confirmModal = document.getElementById("confirmModal");
    
    if (event.target === folderModal) {
        folderModal.style.display = "none";
    }
    if (event.target === confirmModal) {
        closeConfirmModal();
    }
}

// Close modals with Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const folderModal = document.getElementById("folderModal");
    const confirmModal = document.getElementById("confirmModal");
    
    if (folderModal.style.display === "flex") {
      folderModal.style.display = "none";
    }
    if (confirmModal.style.display === "flex") {
      closeConfirmModal();
    }
    
    if (currentViewingUnit) {
      backToHome();
    }
  }
});

// Add drag and drop functionality
document.addEventListener('DOMContentLoaded', function() {
  const uploadBox = document.querySelector('.upload-box');
  
  if (uploadBox) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadBox.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      uploadBox.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadBox.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
      uploadBox.classList.add('dragover');
    }

    function unhighlight(e) {
      uploadBox.classList.remove('dragover');
    }

    uploadBox.addEventListener('drop', handleDrop, false);

    async function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;

      if (files.length > 0 && currentUnitId) {
        console.log("Uploading files:", Array.from(files).map(f => f.name));
        console.log("Unit ID:", currentUnitId);

        const formData = new FormData();
        formData.append('unit_id', currentUnitId);

        // Get selected tag
        const tagSelect = document.getElementById('fileTag');
        const selectedTag = tagSelect ? tagSelect.value : 'study_material';
        formData.append('tag', selectedTag);

        for (let file of files) {
          formData.append('files', file);
        }

        try {
          const response = await fetch('/api/upload-file/', {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken
            },
            body: formData
          });

          console.log("Upload response status:", response.status);
          const data = await response.json();
          console.log("Upload response data:", data);

          if (data.success) {
            showSuccessMessage(`${data.message}! Email notifications sent to all students.`);
            loadUnitFiles(currentUnitId);
          } else {
            alert(data.error || 'Failed to upload files');
          }
        } catch (error) {
          console.error('Error uploading files:', error);
          alert('Failed to upload files. Please try again.');
        }
      } else if (!currentUnitId) {
        alert("Please select a unit first!");
      }
    }
  }
});

function backToHome() {
    currentViewingUnit = null;
    currentUnitId = null;
    
    // Show home section and hide unit view
    document.querySelector(".home-section").style.display = "block";
    document.getElementById("unitView").style.display = "none";
    
    // Update navigation
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => item.classList.remove('active'));
    navItems[0].classList.add('active'); // Make Home active
}

function showHome() {
    // Show home section, hide others
    document.querySelector(".home-section").style.display = "block";
    document.getElementById("unitView").style.display = "none";
    document.querySelector(".files-section-container").style.display = "none";
    
    // Update navigation
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => item.classList.remove('active'));
    navItems[0].classList.add('active');
    
    // Reset unit view state
    currentViewingUnit = null;
    currentUnitId = null;
}

function triggerFileInput() {
    if (!currentUnitId) {
        alert("Please select a unit first.");
        return;
    }
    document.getElementById("fileInput").click();
}

async function deleteFile(fileId, fileName) {
    if (confirm(`Are you sure you want to delete "${fileName}"?`)) {
        try {
            const response = await fetch(`/api/delete-file/${fileId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showSuccessMessage(data.message);
                loadUnitFiles(currentUnitId);
            } else {
                alert(data.error || 'Failed to delete file');
            }
        } catch (error) {
            console.error('Error deleting file:', error);
            alert('Failed to delete file. Please try again.');
        }
    }
}

function downloadFile(fileId) {
    window.open(`/api/download-file/${fileId}/`, '_blank');
    showSuccessMessage('Download started!');
}
function previewPDF(pdfPath) {
    // Opens the PDF in a new browser tab
    window.open(pdfPath, '_blank');
}
</script>
</body>
</html>